<!DOCTYPE html>
<html>
<head>
    <title>wsjf_filterable</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var Ext=window.Ext4||window.Ext;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){this._grid=null,this._boxcontainer=Ext.create("Ext.form.Panel",{title:"Grid Filters",layout:{type:"hbox"},width:"95%",bodyPadding:10}),this._piCombobox=this.add({xtype:"rallyportfolioitemtypecombobox",padding:5,listeners:{select:this._onPICombobox,scope:this}}),this._checkbox=this.add({xtype:"rallycheckboxfield",fieldLabel:"Show Values After the Decimal",labelWidth:200,padding:"5, 5, 5, 10",stateful:!0,stateId:this.getContext().getScopedStateId("mycheckbox"),stateEvents:["change"],value:!1,listeners:{change:this._onPICombobox,scope:this}}),this._boxcontainer.add(this._piCombobox),this._boxcontainer.add(this._checkbox),this.add(this._boxcontainer)},_onPICombobox:function(){console.log("grid: ",this._grid);var selectedType=this._piCombobox.getRecord(),model=selectedType.get("TypePath");null!==this._grid&&this._grid.destroy(),console.log("creating tree store"),Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:[model],listeners:{load:function(store){var records=store.getRootNode().childNodes;console.log("loading"),this._calculateScore(records)},update:function(store,rec,modified,opts){console.log("updating"),this._calculateScore([rec])},scope:this},autoLoad:!0,enableHierarchy:!0}).then({success:this._onStoreBuilt,scope:this})},_onStoreBuilt:function(store,records){var selectedType=this._piCombobox.getRecord(),modelNames=selectedType.get("TypePath");console.log("modelNames: ",modelNames);var context=this.getContext();this._grid=this.add({xtype:"rallygridboard",context:context,modelNames:[modelNames],toggleState:"grid",stateful:!1,plugins:[{ptype:"rallygridboardcustomfiltercontrol",filterChildren:!1,filterControlConfig:{modelNames:[modelNames],stateful:!0,stateId:context.getScopedStateId("custom-filter-example")}},{ptype:"rallygridboardactionsmenu",menuItems:[{text:"Export...",handler:function(){window.location=Rally.ui.grid.GridCsvExport.buildCsvExportUrl(this.down("rallygridboard").getGridOrBoard())},scope:this}],buttonConfig:{iconCls:"icon-export"}}],gridConfig:{store:store,columnCfgs:["Name","TimeCriticality","RROEValue","UserBusinessValue","JobSize",{text:"WSJF Score",dataIndex:"WSJFScore",editor:null}]},height:this.getHeight()})},_calculateScore:function(records){var that=this;Ext.Array.each(records,function(feature){var jobSize=feature.data.JobSize,timeValue=feature.data.TimeCriticality,OERR=feature.data.RROEValue,userValue=feature.data.UserBusinessValue,oldScore=feature.data.WSJFScore,isChecked=!1;if(that._checkbox&&(isChecked=that._checkbox.getValue()),jobSize>0){var score;score=isChecked?Math.floor(100*((userValue+timeValue+OERR)/jobSize))/100:Math.floor((userValue+timeValue+OERR)/jobSize+.5),oldScore!==score&&feature.set("WSJFScore",score)}})}});

            Rally.launchApp('CustomApp', {
                name:"wsjf_filterable",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
